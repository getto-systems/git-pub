#!/bin/bash

git_purge_main(){
  local branch
  local last
  local parent
  local merged_parent

  branch=$(git symbolic-ref --short HEAD)
  if [ "$branch" != master ]; then
    parent=$(git parent)

    git fetch --prune origin
    git fetch --prune pub

    if [ -z "$(git branch -a | grep "origin/$parent"'$')" ]; then
      # parent branch already merged to master, maybe
      merged_parent=$parent
      parent=master
    else
      if [ -n "$(git branch -r --no-merged origin/$parent | grep pub/$branch)" ]; then
        echo "pub/$branch is not merged to origin/$parent"
        exit 1
      fi
    fi

    git delete-pub "$branch" && \
    git branch -d "$parent" && \
    git branch "$parent" "origin/$parent" && \
    git checkout "$parent" && \
    git branch -D "$branch" && \
    :

    if [ -n "$merged_parent" ]; then
      git branch -D "$merged_parent"
    fi
  fi
}

git_purge_main
