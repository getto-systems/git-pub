#!/bin/bash

git_purge_main(){
  local branch
  local last
  local parent

  branch=$(git symbolic-ref --short HEAD)
  if [ "$branch" != master ]; then
    git fetch origin
    git fetch pub

    parent=$(git parent)
    if [ -n "$(git branch -r --no-merged origin/$parent | grep pub/$branch)" ]; then
      echo "pub/$branch is not merged to origin/$parent"
      exit 1
    fi

    git delete-pub "$branch" && \
    git branch -d "$parent" && \
    git branch "$parent" "origin/$parent" && \
    git checkout "$parent" && \
    git branch -D "$branch" && \
    :
  fi
}

git_purge_main
